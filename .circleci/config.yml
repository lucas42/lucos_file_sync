version: 2.1
orbs:
  deploy: lucos/deploy@0.0.0
jobs:
  build:
    parameters:
      architecture:
        type: string
    environment:
      ARCH: << parameters.architecture >>
    docker:
      - image: circleci/buildpack-deps:buster
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: docker-compose build
      - run:
          name: Publish Docker Image to Docker Hub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
            docker-compose push
workflows:
  version: 2
  build-deploy:
    jobs:
      - build:
          context: docker
          architecture: amd64
      - deploy/remote-build:
          context: docker
          build-domain: xwing.s.l42.eu
          ssh-port: 2222
          architecture: arm
      - deploy/deploy:
          context: docker
          host-domain: valen.s.l42.eu
          architecture: amd64
          requires:
            - build
          filters:
            branches:
              only:
                - main
      - deploy/deploy:
          context: docker
          host-domain: xwing.s.l42.eu
          architecture: arm
          requires:
            - deploy/remote-build
          filters:
            branches:
              only:
                - main